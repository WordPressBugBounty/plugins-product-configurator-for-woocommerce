var PC=PC||{};PC.toJSON=function(e){var t,i,n,a=PC._us||window._;if(e instanceof Backbone.Collection)return t=[],e.each(function(e){t.push(PC.toJSON(e))}),t;for(n in i=e instanceof Backbone.Model?a.clone(e.attributes):a.clone(e))(i[n]instanceof Backbone.Model||i[n]instanceof Backbone.Collection||i[n]instanceof Object)&&(i[n]=PC.toJSON(i[n]));return i},((s,d)=>{PC.actionParameter="pc_get_data",PC.setActionParameter="pc_set_data",PC.app=PC.app||{is_modified:{layers:!1,angles:!1,content:!1},modified_choices:[],state:null,init:function(e){if(PC.lang=PC_lang||{},void 0===e.product_id)throw{name:"Error",message:"product_id parameter is missing to start the configurator."};e=this.id="simple"==e.product_type?e.product_id:e.parent_id;return this.admin||(this.admin_data=new PC.admin({id:e}),this.admin=new PC.views.admin({model:this.admin_data})),this.admin},start:function(e){this.options=e||{},this.admin||this.init(e),this.admin.open(e)},get_admin:function(){return this.admin},get_product:function(){return this.admin.get_current_product()},get_collection:function(e){switch(e){case"content":case"conditions":return this.get_product().get(e);default:return this.admin[e]}},get_layer_content:function(e){var t=PC.app.get_collection("content");return!!t&&!!(t=t.get(e))&&t.get("choices")},get_choice_model:function(e,t){return this.get_layer_content(e).get(t)||!1},save_all:function(i,n){var a,o;this.saving=0,this.errors=[],-1!=d.indexOf(d.values(this.is_modified),!0)?(i&&(i.$save_button.addClass("disabled"),i.$save_all_button.addClass("disabled"),i.$toolbar.addClass("saving"),i.$el.addClass("saving")),a=0,o=d.filter(d.values(this.is_modified),function(e){return!0===e}).length,s.each(this.is_modified,function(e,t){a++,1==t&&(this.saving++,this.save(e,this.get_collection(e),{success:d.bind(this.saved_all,this,e,i,n),error:d.bind(this.error_saving,this,e,i,n),data:{saveCache:a===o}}))}.bind(this))):n&&n.saved_all&&n.saved_all()},error_saving:function(e,t,i,n){this.errors.push(n),this.saving--,0==this.saving&&(t.state_saved(1),console.log(e,this.errors,t,i,n),alert(this.errors.join("/n")))},saved_all:function(e,t,i){this.saving--,this.is_modified[e]=!1,i&&i.saved_one&&i.saved_one(e),0==this.saving&&(t&&t.state_saved&&t.state_saved(),i)&&i.saved_all&&i.saved_all(),PC.app.modified_choices=[]},save:function(i,e,n){var t;if(i&&e)return t=this.id,"variation"!=this.options.product_type||"content"!=i&&"conditions"!=i||(t=this.options.product_id),PC_lang.update_nonce?this.is_modified[i]?((n=n||{}).context=this,n.timeout=parseInt(wp.hooks.applyFilters("mkl_pc_admin.save_timeout",PC_lang.timeout||3e4)),n.data=d.extend(n.data||{},{action:PC.setActionParameter,id:t,nonce:PC_lang.update_nonce,data:i}),t!=this.id&&(n.data.parent_id=this.id),0<e.length?(e instanceof Array?(n.data[i]={},s.each(e,function(e,t){n.data[i][e]=t instanceof Backbone.Collection?JSON.stringify(t):t})):e instanceof Backbone.Collection&&(n.data[i]=JSON.stringify(e)),"content"==i&&(n.data.modified_choices=PC.app.modified_choices)):n.data[i]="empty",wp.ajax.send(n)):(console.log("not modified"),!1):(console.log("nonce problem"),s.Deferred().rejectWith(this).promise());console.log("A collection name and data must be set in order to save proprerly.")},get_new_id:function(e){return e.length<1?1:(e=e.max(function(e){return e.id}),parseInt(e.id)+1)},get_new_order:function(e){return e.length?e.last().get("order")+1:1},new_attributes:function(e,t){return d.extend(t,{_id:this.get_new_id(e),order:this.get_new_order(e),active:!0})},get_data_from_clipboard:function(){}},PC.selection_collection=Backbone.Collection.extend({comparator:"order",adding_group:!1,modelId:function(e){return e._id},is_multiple:function(){return!!(1<this.length)},select:function(e){var t;this.adding_group||(t=e.model,this.remove(this.get(t.id)),t.get("active")&&this.add({_id:t.id,view:e,order:t.get("order")}))}}),PC.selection=new PC.selection_collection,PC.media=PC.media||{frame:function(){return this._frame||(this._frame=wp.media({title:PC.lang.media_title||"Select An Image",button:{text:PC.lang.media_select_button||"Select"},multiple:!1,library:{type:"image"}}),this._frame.on("ready",this.ready),this._frame.state("library").on("select",this.select),this._frame.on("close",this.close)),this._frame},ready:function(){},select:function(){wp.media.view.settings;var e=this.get("selection").single();PC.media.target&&PC.media.target.trigger("select-media",e)},close:function(){this.admin=this.admin||PC.app.get_admin(),this.admin_modal=this.admin_modal||this.admin.get_current_modal(),this.admin_modal.$el.show()},open:function(i){this.admin=this.admin||PC.app.get_admin(),this.admin_modal=this.admin_modal||this.admin.get_current_modal(),this.admin_modal.$el.hide(),i instanceof jQuery?this.target=i:i.el&&(this.target=i.el),this.frame().on("open",function(){var e,t=this.frame().state().get("selection");i.selection?(e=i.selection,e=wp.media.attachment(e),t.add(e?[e]:[])):t.reset(null)}.bind(this)),this.frame().open()}},PC.copy_items=function(e){var i={type:null,models:[]};e.collection instanceof PC.layers?i.type="layers":e.collection instanceof PC.choices?i.type="choices":e.collection instanceof PC.angles&&(i.type="angles"),i.type&&(PC.selection.each(e=>{var t;"layers"==i.type||"angles"==i.type?(t=PC.app.get_layer_content(e.get("view")?.model?.id),t={layer:e.get("view").model.toJSON(),content:t?t.toJSON():[]},i.models.push(t)):i.models.push(e.get("view").model.toJSON())}),navigator.clipboard.writeText(JSON.stringify(i)).then(e=>{PC.show_notice('Configuration copied to clipboard. Go to "Edit > Paste" or "Ctrl/Cmd + v" to paste.')}))},PC.show_notice=function(e,t="success"){let i=document.createElement("div");var n=PC.app.get_product().editor.$(".notice-container")[0];n&&(i.className="pc-notice notice-"+t,i.innerText=e,e=document.createElement("span"),"success"==t&&(e.className="dashicons dashicons-saved",i.prepend(e)),"error"==t&&(e.className="dashicons dashicons-no",i.prepend(e)),"saved"==t&&(e.className="dashicons dashicons-saved",i.prepend(e),s("#sample-permalink").length)&&(t=s("#sample-permalink a").first(),(e=document.createElement("a")).href=t[0].href,e.className="view-product",e.target="_blank",i.append(e)),n.appendChild(i),setTimeout(()=>i.remove(),5e3))}})(jQuery,PC._us||window._);