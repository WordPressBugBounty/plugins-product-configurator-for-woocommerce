var PC=PC||{};PC.views=PC.views||{},(n=>{function e(s){var e=s.$(".field-repeater");e.length&&e.each((e,t)=>{var i=n(t).data("setting"),o=n(t).data("fields");new PC.views.field_repeater({el:n(t),setting:i,fields:o,model:s.model}).$el.appendTo(n(t))})}wp.hooks.addAction("PC.admin.layer_form.render","MKL/PC/Field_Repeater",e),wp.hooks.addAction("PC.admin.choiceDetails.render","MKL/PC/Field_Repeater",e),PC.views.field_repeater=Backbone.View.extend({template:wp.template("mkl-pc-setting--repeater"),events:{"click .add-option":"add_option"},options_els:[],initialize:function(e){this.setting=e.setting,this.fields=e.fields,"object"!=typeof(e=this.model.get(this.setting))&&(e=[]),this.options=new Backbone.Collection(e,{comparator:"order"}),this.render(),this.listenTo(this.options,"add",this.add_one),this.listenTo(this.options,"change destroy",this.save_options)},get_default_option:function(){var e=Object.keys(this.fields).reduce((e,t)=>{var i=this.fields[t];return e[t]=void 0!==i.default?i.default:"",e},{});return e.order=PC.app.get_new_order(this.options),wp.hooks.applyFilters("PC.field.repeater.get_default_option",e)},render:function(){this.$el.append(this.template()),this.options.each(this.add_one.bind(this))},add_option:function(){this.options.add(this.get_default_option())},add_one:function(e){e=new PC.views.field_repeater_option({fields:this.fields,model:e});this.options_els.push(e),e.$el.appendTo(this.$(".options-list"))},save_options:function(){this.options.each(function(e){e.get("label")||e.get("value")||this.options.remove(e)}),this.model.set(this.setting,PC.toJSON(this.options.sort()))}}),PC.views.field_repeater_option=Backbone.View.extend({tagName:"div",className:"field-repeater--option",template:wp.template("mkl-pc-setting--repeater-option"),events:{"click .remove-option":"remove_option","change input":"update_value","click .order button":"reorder_item"},initialize:function(e){this.fields=e.fields,this.listenTo(this.model.collection,"manual-reorder",this.set_order),this.render()},render:function(){this.$el.append(this.template({...this.model.attributes,fields:this.fields}))},remove_option:function(){this.model.destroy(),this.remove()},update_value:function(e){this.model.set(e.target.name,e.target.value)},reorder_item:function(e){var t,i=!1;n(e.currentTarget).is(".up")?(t=this.$el.prev()).length&&(this.$el.insertBefore(t),i=!0):n(e.currentTarget).is(".down")&&(t=this.$el.next()).length&&(this.$el.insertAfter(t),i=!0),i&&this.model.collection.trigger("manual-reorder")},set_order:function(){this.model.set("order",this.$el.index())}})})(jQuery,PC._us||window._);